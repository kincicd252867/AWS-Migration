AWSTemplateFormatVersion: '2010-09-09'
Description: Nested stack to create security groups for migration
Parameters:
  EnvironmentName:
    Type: String
  VpcId:
    Type: String

Resources:
  MigrationSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable traffic for AWS MGN and DMS
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-migration-sg'

  DBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for the target RDS database
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref MigrationSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub '${EnvironmentName}-db-sg'

Outputs:
  MigrationSecurityGroupId:
    Description: ID of the Migration Security Group
    Value: !Ref MigrationSecurityGroup
  DBSecurityGroupId:
    Description: ID of the Database Security Group
    Value: !Ref DBSecurityGroup